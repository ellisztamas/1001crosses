---
title: "PCA in the parents and progeny"
author: "Tom Ellis"
date: today
format:
  html:
    toc: true
    html-math-method: katex
    self-contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, cache.lazy=TRUE)
# 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

suppressPackageStartupMessages(library("tidyverse"))
library("ggpubr")
library("qqman")
```

```{r pca-data}
# List of file paths giving eigenvectors
eigenvec_files <- list(
  parents = "05_results/01_pca/output/parental_lines.eigenvec",
  progeny = "05_results/01_pca/output/F8_imputed.eigenvec"
)
# List of file paths giving eigen values
eigenval_files <- list(
  parents = "05_results/01_pca/output/parental_lines.eigenval",
  progeny = "05_results/01_pca/output/F8_imputed.eigenval"
)

# Import PCA data
eigenvecs <- lapply(names(eigenvec_files), function(name){
  filename <- eigenvec_files[[name]]
  read.table(filename, header=TRUE) %>%
    as_tibble() %>%
    mutate(
      dataset = name,
      FID = as.character(FID),
      IID = as.character(IID)
    )
})
names(eigenvecs) <- names(eigenvec_files)

eigenvals <- lapply(names(eigenval_files), function(name){
  filename <- eigenval_files[[name]]
  read.table(filename, col.names="eigenval", header=FALSE) %>%
    as_tibble() %>%
    mutate(
      eigenval = round(100*(eigenval / sum(eigenval)), 1),
      dataset = name
    )
})
names(eigenvals) <- names(eigenval_files)
```

```{r gps-data}
gps <- read_csv(
  "03_processing/06_process_phenotypes/output/parental_GPS_coordinates.csv",
  col_select = c('id', 'latitude', 'longitude'),
  show_col_types = FALSE
) %>%  
  mutate(
    FID = as.character(id)
  )

eigenvecs$parents <- eigenvecs$parents %>% 
  left_join(gps, by = "FID")
```

```{r}
admixture_groups <- read_csv(
  "01_data/03_parental_genotypes/admixture_groups_filiault_etal_2025.csv",
  col_names = c("FID", "group"),
  col_types = 'cc'
)

eigenvecs$parents <- eigenvecs$parents %>% 
  left_join(admixture_groups, by = "FID")

```



```{r ft12-data}
# BLUPs for flowering time at 12°C
ft12 <- list(
  progeny = read_tsv(
    "03_processing/06_process_phenotypes/output/flowering_time_blups_F9_combined.tsv",
    col_types = 'fcd',
    col_names = c('intercept', 'FID', 'days_to_flower')
  ),
  
  parents = read_tsv(
    "03_processing/06_process_phenotypes/output/flowering_time_blups_parents.tsv",
    col_types = 'fcd',
    col_names = c('intercept', 'FID', 'days_to_flower')
  )
)

eigenvecs$parents <- eigenvecs$parents %>% 
  left_join(ft12$parents, by = "FID")
eigenvecs$progeny <- eigenvecs$progeny %>% 
  left_join(ft12$progeny, by = "FID")

```

```{r rosette-data}
# BLUPs
rosette_size <- list(
  progeny = read_tsv(
    "03_processing/06_process_phenotypes/output/rosette_size_blups_F9_combined.tsv",
    col_types = 'fcd',
    col_names = c('intercept', 'FID', 'rosette_size')
  ),
  
  parents = read_tsv(
    "03_processing/06_process_phenotypes/output/rosette_size_blups_parents.tsv",
    col_types = 'fcd',
    col_names = c('intercept', 'FID', 'rosette_size')
  )
)

eigenvecs$parents <- eigenvecs$parents %>% 
  left_join(rosette_size$parents, by = "FID")
eigenvecs$progeny <- eigenvecs$progeny %>% 
  left_join(rosette_size$progeny, by = "FID")

```

```{r seed-size-data}
# BLUPs
seed_size <- list(
  progeny = read_tsv(
    "03_processing/06_process_phenotypes/output/seed_size_blups_F9_combined.tsv",
    col_types = 'fcd',
    col_names = c('intercept', 'FID', 'seed_size')
  ),
  
  parents = read_tsv(
    "03_processing/06_process_phenotypes/output/seed_size_blups_parents.tsv",
    col_types = 'fcd',
    col_names = c('intercept', 'FID', 'seed_size')
  )
)

eigenvecs$parents <- eigenvecs$parents %>% 
  left_join(seed_size$parents, by = "FID")
eigenvecs$progeny <- eigenvecs$progeny %>% 
  left_join(seed_size$progeny, by = "FID")

```

This document investigates principle components of genetic variation in 219 parental and 501 (imputed) F8 datasets.

## Basic PCA

Looking first at the variance explained by each PC, eigenvectors for the parents start high and decay within 20 PCs. Eigenvectors for the F8s start lower but are otherwise similar.

```{r eigenvalues}
rbind(
  eigenvals$parents,
  eigenvals$progeny
) %>% 
  mutate(
    PC = rep(1:20, 2)
  ) %>% 
  ggplot(aes(x = PC, y=eigenval)) +
  geom_line() + 
  geom_point() +
  labs(
    x = "Principle component",
    y = "Eigenvalue"
  ) +
  facet_grid(~ dataset)
```

A first comparison shows that structure in the parents is L-shaped, roughly corresponding to PCs 1 and 2.
In the F8s there are again two axis, with some lines in between.
That is consistent with mating within and between the two axes.

```{r basic-pca}
ggarrange(
  eigenvecs$parents %>%
    ggplot(aes(x=PC1, y = PC2)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)"),
      title = "Parents"
    ) +
    theme_bw(),
  
  eigenvecs$progeny %>%
    ggplot(aes(x=PC1, y = -PC2)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$progeny$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$progeny$eigenval[2], "%)"),
      title = "Progeny"
    ) +
    theme_bw(),
  
  ncol =2
)
```

F8 cohorts are well mixed.

```{r f8-cohorts-mixed}
eigenvecs$progeny %>%
  mutate(cohort = case_when(
    grepl("_rep1", FID) ~ "Cohort 1",
    grepl("_rep2", FID) ~ "Cohort 2",
    .default = NA
  )) %>% 
  ggplot(aes(x=PC1, y = -PC2, colour = cohort)) +
  geom_point() +
  labs(
    x = paste0("PC1 (", eigenvals$progeny$eigenval[1], "%)"),
    y = paste0("PC2 (", eigenvals$progeny$eigenval[2], "%)"),
    title = "Progeny by cohort"
  ) +
  theme_bw()
```


## What are PCs correlated with?

### Geography

PC1 appears to be correlated with latitude, with higher values found further further North.

```{r pca-long-lat}
eigenvecs$parents %>% 
  ggplot(aes(x=PC1, y = PC2, colour = latitude)) +
  geom_point() +
  labs(
    x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
    y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)"),
    title = "Parents"
  ) +
  theme_bw()
```

PC1 stands out as being strongly correlated with latitude (also longitude, but the point is moot because Sweden is wonky).

```{r geography-cor}

geography_cor <- tibble(
  PC = 1:18,
  latitude = rep(NA, 18),
  longitude = rep(NA, 18)
  )

for(i in 3:20){
  geography_cor$latitude[i-2] <- cor(
    eigenvecs$parents$latitude,
    eigenvecs$parents[,i],
    method = 's', use = 'p'
  )
  geography_cor$longitude[i-2] <- cor(
    eigenvecs$parents$longitude,
    eigenvecs$parents[,i],
    method = 's', use = 'p'
  )
}

geography_cor %>% 
  pivot_longer(latitude:longitude, values_to = "correlation") %>% 
  ggplot(aes(x=PC, y=correlation)) +
  geom_point() +
  labs(
    x = "Principle component",
    y = "Correlation coefficient"
  ) +
  facet_grid(~name)

```

You can see broadly the same pattern if you plot them on a map.
Accession 175 is from France - this was in the original sample sheet and appears to be deliberate, or else snuck in.
There is also one whacky accession from the Netherlands (7002).
This was originally something else, but I identified it as a parent during validation.

```{r map}

map_data('world') %>% 
  ggplot() +
  # Plot an empty map of the world
  # Borders are shown the same colour as the country backgrounds
  geom_polygon(
    aes(x=long, y = lat, group = group),
    fill="gray90", colour="gray70") + 
  coord_fixed(
    xlim = range(eigenvecs$parents$longitude, na.rm = TRUE),
    ylim = range(eigenvecs$parents$latitude, na.rm = TRUE),
    1.5
  ) +
  # Overplot the accessions
  geom_point(
    data = eigenvecs$parents ,
    aes(x=longitude, y = latitude, colour=PC1)) +
  labs(
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_bw() +
  theme(
    # legend.position = "none",
    # legend.title = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )

# There's a whacky accession from the Netherlands (7002)
eigenvecs$parents %>%
  # filter(latitude >62) %>%
  arrange(desc(latitude)) %>% 
  select(IID, id, latitude, longitude, PC1, PC2, group) %>% 
  View()

```

Here is a zoom-in on the south of Sweden.

```{r}
map_data('world') %>% 
  ggplot() +
  # Plot an empty map of the world
  # Borders are shown the same colour as the country backgrounds
  geom_polygon(
    aes(x=long, y = lat, group = group),
    fill="gray90", colour="gray70") + 
  coord_fixed(
    xlim = c(13,15),
    ylim = c(55.2,56.3),
    # xlim = c(17,19),
    # ylim = c(62,63.5),
    1.5
  ) +
  # Overplot the accessions
  geom_point(
    data = eigenvecs$parents ,
    aes(x=longitude, y = latitude, colour=group)) +
  labs(
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_bw() +
  theme(
    # legend.position = "none",
    # legend.title = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
```

The following plot shows the scatter plot of the main PCs against latitude for the parental lines.
First, you can see the three lines from central Europe at low latitude.
Ignoring those, we can see that PC1 is basically driven by the difference between Skåne and the high coast.
There is no meaningful correlation between latitude and PC2.

```{r}

ggarrange(
eigenvecs$parents %>% 
  ggplot(aes(x=latitude, y = PC1)) +
  geom_point() +
  labs(
    x = "Latitude",
    y = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
    title = "PC1"
  ) +
  theme_bw(),

eigenvecs$parents %>% 
  ggplot(aes(x=latitude, y = PC2)) +
  geom_point() +
  labs(
    x = "Latitude",
    y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)"),
    title = "PC2"
  ) +
  theme_bw(),
ncol=2
)
```

Filault *et al.* (2025) looked at local adaptation among Swedish accessions using a panel very similar to the parents used here.
They distinguished four admixture groups:

* Beach lines (B)
* Northern lines (N)
* Southern lines 1 (S1)
* Southern lines 2 (S2)

Here the parents coloured by admixture group:

* PC1 separates northern and southern Sweden.
* PC2 separates group S2 from everyone else.
* PC3 separates the beach lines from everyone else.


```{r pca-admixture-group}
ggarrange(
  eigenvecs$parents %>% 
    ggplot(aes(x=PC1, y = PC2, colour = group)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)")
    ) +
    theme_bw(),
  eigenvecs$parents %>% 
    ggplot(aes(x=PC1, y = PC3, colour = group)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
      y = paste0("PC3 (", eigenvals$parents$eigenval[3], "%)")
    ) +
    theme_bw(),
  common.legend = TRUE, ncol=2, nrow=1
)
```

### Flowering time

There is no obvious correlation between flowering time at 12°C and PCs 1 and 2.

```{r}

ggarrange(
  eigenvecs$parents %>% 
    ggplot(aes(x=PC1, y = PC2, colour = days_to_flower)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)"),
      title = "Parents"
    ) +
    theme_bw(),
  
  eigenvecs$progeny %>% 
    ggplot(aes(x=PC1, y = -PC2, colour = days_to_flower)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$progeny$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$progeny$eigenval[2], "%)"),
      title = "Progeny"
    ) +
    theme_bw(),
  
  ncol=1, nrow=2
)

```

Plotting Spearman-rank correlations shows that there are some modest correlations.

```{r}

ft12_cor <- tibble(
  PC = 1:18,
  parents = rep(NA, 18),
  progeny = rep(NA, 18)
)

# plot(
#   eigenvecs$parents$PC1,
#   eigenvecs$parents$days_to_flower
# )

for(i in 3:20){
  ft12_cor$parents[i-2] <- cor(
    eigenvecs$parents$days_to_flower,
    eigenvecs$parents[,i],
    method = 's', use = 'p'
  )
  
  ft12_cor$progeny[i-2] <- cor(
    eigenvecs$progeny$days_to_flower,
    eigenvecs$progeny[,i],
    method = 's', use = 'p'
  )
}


ft12_cor %>% 
  pivot_longer(parents:progeny, values_to = "correlation") %>% 
  ggplot(aes(x=PC, y=correlation)) +
  geom_point() +
  labs(
    x = "Principle component",
    y = "Correlation with flowering time"
  ) +
  facet_grid(~name)


```

### Rosette size

There again seems to be no correlation between PCs 1 and 2 and rosette size.

```{r}
ggarrange(
  eigenvecs$parents %>% 
    ggplot(aes(x=PC1, y = PC2, colour = rosette_size)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)"),
      title = "Parents"
    ) +
    theme_bw(),
  
  eigenvecs$progeny %>% 
    ggplot(aes(x=PC1, y = PC2, colour = rosette_size)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$progeny$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$progeny$eigenval[2], "%)"),
      title = "Progeny"
    ) +
    theme_bw(),
  
  ncol=1, nrow=2
)

```

Plotting correlation coefficients also shows that correlations are generally weaker.

```{r}

rs_cor <- tibble(
  PC = 1:18,
  parents = rep(NA, 18),
  progeny = rep(NA, 18)
)

plot(
  eigenvecs$parents$PC1,
  eigenvecs$parents$rosette_size
)

for(i in 3:20){
  rs_cor$parents[i-2] <- cor(
    eigenvecs$parents$rosette_size,
    eigenvecs$parents[,i],
    method = 's', use = 'p'
  )
  
  rs_cor$progeny[i-2] <- cor(
    eigenvecs$progeny$rosette_size,
    eigenvecs$progeny[,i],
    method = 's', use = 'p'
  )
}


rs_cor %>% 
  pivot_longer(parents:progeny, values_to = "correlation") %>% 
  ggplot(aes(x=PC, y=correlation)) +
  geom_point() +
  labs(
    x = "Principle component",
    y = "Correlation with rosette size"
  ) +
  facet_grid(~name)


```

### Seed size

It appears that seed size is correlated with PC1 (and hence latitude) in the parents, but not the F8s.

```{r}
ggarrange(
  eigenvecs$parents %>% 
    ggplot(aes(x=PC1, y = PC2, colour = seed_size)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$parents$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$parents$eigenval[2], "%)"),
      title = "Parents"
    ) +
    theme_bw(),
  
  eigenvecs$progeny %>% 
    ggplot(aes(x=PC1, y = PC2, colour = seed_size)) +
    geom_point() +
    labs(
      x = paste0("PC1 (", eigenvals$progeny$eigenval[1], "%)"),
      y = paste0("PC2 (", eigenvals$progeny$eigenval[2], "%)"),
      title = "Progeny"
    ) +
    theme_bw(),
  
  ncol=1, nrow=2
)

```

The correlation coefficients reveal that the first two PCs are actually surprising correlated in *both* the parents and F8s.
This would be consistent with seed size being highly polygenic, such that seed size is proportional to how much Northern/Southern Swedish genome you have.

```{r}

ss_cor <- tibble(
  PC = 1:18,
  parents = rep(NA, 18),
  progeny = rep(NA, 18)
)

for(i in 3:20){
  ss_cor$parents[i-2] <- cor(
    eigenvecs$parents$seed_size,
    eigenvecs$parents[,i],
    method = 's', use = 'p'
  )
  
  ss_cor$progeny[i-2] <- cor(
    eigenvecs$progeny$seed_size,
    eigenvecs$progeny[,i],
    method = 's', use = 'p'
  )
}


ss_cor %>% 
  pivot_longer(parents:progeny, values_to = "correlation") %>% 
  ggplot(aes(x=PC, y=correlation)) +
  geom_point() +
  labs(
    x = "Principle component",
    y = "Correlation with seed size"
  ) +
  facet_grid(~name)


```



```{r}
eigenvecs$parents %>% 
  ggplot(aes(x = PC1, y = seed_size, colour =group)) +
  geom_point()

eigenvecs$parents %>% 
  ggplot(aes(x = PC3, y = seed_size, colour =group)) +
  geom_point()

eigenvecs$parents %>% 
  filter(PC2 > 0.1, seed_size > 0.02)
```


